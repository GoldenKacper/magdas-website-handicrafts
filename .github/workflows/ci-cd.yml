name: CI & Deploy to Hostido

on:
  push:
    branches:
      - main

env:
  LARAVEL_DIR: src/website-handicrafts

jobs:
  tests:
    runs-on: ubuntu-latest
    outputs:
      tests-passed: ${{ steps.phpunit.outcome == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          extensions: mbstring, pdo_mysql, zip, bcmath
          ini-values: post_max_size=256M, upload_max_filesize=256M

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Composer dependencies (include dev for tests)
        working-directory: ${{ env.LARAVEL_DIR }}
        run: composer install --no-interaction --prefer-dist

      - name: Install NPM dependencies
        working-directory: ${{ env.LARAVEL_DIR }}
        run: |
          npm ci
          npm run build

      - name: Prepare project root .env for tests
        working-directory: ./
        run: cp .env.example .env

      - name: Prepare laravel .env for tests (static)
        working-directory: ${{ env.LARAVEL_DIR }}
        run: |
          # skopiuj przykład .env (jeśli plik już istnieje - nadpisz)
          cp .env.example .env || true

          # ustaw bezpieczny APP_URL (aby uniknąć Invalid URI)
          if grep -q "^APP_URL=" .env; then
            sed -i "s|^APP_URL=.*|APP_URL=http://localhost:8000|" .env
          else
            echo "APP_URL=http://localhost:8000" >> .env
          fi

          # wymuś sqlite in-memory dla testów (nie potrzebujesz MySQL na runnerze)
          if grep -q "^DB_CONNECTION=" .env; then
            sed -i "s|^DB_CONNECTION=.*|DB_CONNECTION=sqlite|" .env
          else
            echo "DB_CONNECTION=sqlite" >> .env
          fi
          if grep -q "^DB_DATABASE=" .env; then
            sed -i "s|^DB_DATABASE=.*|DB_DATABASE=:memory:|" .env
          else
            echo "DB_DATABASE=:memory:" >> .env
          fi

          # opcjonalne: uproszczenie sterowników cache/session/queue do trybu testowego
          sed -i "s|^SESSION_DRIVER=.*|SESSION_DRIVER=array|" .env || true
          sed -i "s|^CACHE_STORE=.*|CACHE_STORE=array|" .env || true
          sed -i "s|^QUEUE_CONNECTION=.*|QUEUE_CONNECTION=sync|" .env || true

          # pokaż fragment .env (bez haseł) — tylko do debugowania, usuń jeśli nie chcesz logów
          echo "---- generated .env (head) ----"
          head -n 40 .env | sed -e 's/\(DB_PASSWORD=\).*/\1[REDACTED]/' -e 's/\(APP_KEY=\).*/\1[REDACTED]/'
          echo "---- end ----"

          # wygeneruj klucz aplikacji
          php artisan key:generate

      - name: Run migrations for tests (sqlite in-memory)
        working-directory: ${{ env.LARAVEL_DIR }}
        run: php artisan migrate --env=testing --force
        continue-on-error: false

      - name: Run PHPUnit
        working-directory: ${{ env.LARAVEL_DIR }}
        run: vendor/bin/phpunit --colors=always --testdox
      # deploy job will run only if push to main and tests ok

  deploy:
    needs: tests
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (for deploy)
        uses: actions/checkout@v4

      - name: Deploy via SSH to Hostido (git pull & build)
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.HOSTIDO_HOST }}
          username: ${{ secrets.HOSTIDO_USER }}
          key: ${{ secrets.HOSTIDO_SSH_PRIVATE_KEY }}
          port: ${{ secrets.HOSTIDO_PORT }}
          script: |
            set -e
            # ścieżka, którą podałeś: /domains/handmademalin.pl/app
            PROJECT_ROOT="${{ secrets.HOSTIDO_PROJECT_PATH }}"
            LARAVEL_DIR="$PROJECT_ROOT/src/website-handicrafts"

            echo "Project root: $PROJECT_ROOT"
            echo "Laravel dir: $LARAVEL_DIR"

            cd "$PROJECT_ROOT"

            # Upewnij się, że remote jest na SSH (git@github.com:...)
            git fetch --all
            git reset --hard origin/main

            # Instalacja composer w wewnętrznym katalogu laravela
            cd "$LARAVEL_DIR"
            composer install --no-interaction --no-dev --optimize-autoloader

            # Jeśli chcesz budować frontend na serwerze (jeżeli node jest zainstalowany)
            if command -v npm >/dev/null 2>&1; then
              npm ci
              npm run build
            else
              echo "npm nie znaleziony na serwerze — pomijam build frontu"
            fi

            # Migracje i cache (wykonujemy w katalogu laravel)
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan storage:link || true

            # Kopiujemy zawartość public do public_html (Hostido standard)
            # Zakładam, że public_html jest obok app (typowe dla Hostido: /domains/handmademalin.pl/public_html)
            PUBLIC_HTML_DIR="/domains/handmademalin.pl/public_html"
            if [ -d "$PUBLIC_HTML_DIR" ]; then
              echo "Kopiuję public do $PUBLIC_HTML_DIR"
              cp -r "$LARAVEL_DIR/public/"* "$PUBLIC_HTML_DIR/"
            else
              echo "Nie znaleziono $PUBLIC_HTML_DIR — sprawdź ścieżkę public_html"
            fi

            # Uprawnienia
            chmod -R 775 "$LARAVEL_DIR/storage" "$LARAVEL_DIR/bootstrap/cache" || true
            chown -R www-data:www-data "$LARAVEL_DIR/storage" "$LARAVEL_DIR/bootstrap/cache" || true

            echo "Deployed successfully!"
