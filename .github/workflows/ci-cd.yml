name: CI & Deploy to Hostido

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  LARAVEL_DIR: src/website-handicrafts

jobs:
  tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.4
        env:
          MYSQL_ROOT_PASSWORD: rootpass
          MYSQL_DATABASE: test_db
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_pass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      LARAVEL_DIR: src/website-handicrafts
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: test_db
      DB_USERNAME: test_user
      DB_PASSWORD: test_pass

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          extensions: mbstring, pdo_mysql, pdo_sqlite, zip
          ini-values: post_max_size=256M, upload_max_filesize=256M

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Composer dependencies (including dev)
        working-directory: ${{ env.LARAVEL_DIR }}
        run: composer install --no-interaction --prefer-dist

      - name: Build frontend (Vite)
        working-directory: ${{ env.LARAVEL_DIR }}
        run: |
          npm ci
          npm run build

      - name: Prepare project root .env for tests
        working-directory: ./
        run: cp .env.example .env

      - name: Prepare .env for tests (use MySQL service)
        working-directory: ${{ env.LARAVEL_DIR }}
        run: |
          cp .env.example .env || true

          # set safe APP_URL (to avoid Invalid URI)
          if grep -q "^APP_URL=" .env; then
            sed -i "s|^APP_URL=.*|APP_URL=http://localhost:8000|" .env
          else
            echo "APP_URL=http://localhost:8000" >> .env
          fi

          # set DB to mysql run as a service
          sed -i "s|^DB_CONNECTION=.*|DB_CONNECTION=mysql|" .env || true
          sed -i "s|^DB_HOST=.*|DB_HOST=127.0.0.1|" .env || true
          sed -i "s|^DB_PORT=.*|DB_PORT=3306|" .env || true
          sed -i "s|^DB_DATABASE=.*|DB_DATABASE=test_db|" .env || true
          sed -i "s|^DB_USERNAME=.*|DB_USERNAME=test_user|" .env || true
          sed -i "s|^DB_PASSWORD=.*|DB_PASSWORD=test_pass|" .env || true

          # set some test modes
          sed -i "s|^SESSION_DRIVER=.*|SESSION_DRIVER=array|" .env || true
          sed -i "s|^CACHE_STORE=.*|CACHE_STORE=array|" .env || true
          sed -i "s|^QUEUE_CONNECTION=.*|QUEUE_CONNECTION=sync|" .env || true

          # Clear config cache so Laravel reads new .env
          php artisan config:clear || true

          php artisan key:generate

      - name: Wait for MySQL to be ready
        working-directory: ${{ env.LARAVEL_DIR }}
        run: |
          echo "Waiting for MySQL..."
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -P 3306 -u test_user -ptest_pass --silent; then
              echo "MySQL is up"
              break
            fi
            echo "MySQL not ready yet, sleeping..."
            sleep 2
          done

      - name: Run migrations
        working-directory: ${{ env.LARAVEL_DIR }}
        run: php artisan migrate --force

      - name: Run PHPUnit
        working-directory: ${{ env.LARAVEL_DIR }}
        env:
          # additional safety: if phpunit.xml has settings, override them
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: test_db
          DB_USERNAME: test_user
          DB_PASSWORD: test_pass
        run: vendor/bin/phpunit --colors=always --testdox
      # deploy job will run only if push to main and tests ok

  deploy:
    needs: tests
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (for deploy)
        uses: actions/checkout@v4

      - name: Deploy via SSH to Hostido (git pull & build)
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.HOSTIDO_HOST }}
          username: ${{ secrets.HOSTIDO_USER }}
          key: ${{ secrets.HOSTIDO_SSH_PRIVATE_KEY }}
          port: ${{ secrets.HOSTIDO_PORT }}
          script: |
            set -e
            # path you provided: ~/domains/handmademalin.pl/app
            PROJECT_ROOT="${{ secrets.HOSTIDO_PROJECT_PATH }}"
            LARAVEL_SUBPATH="src/website-handicrafts"
            LARAVEL_DIR="$PROJECT_ROOT/$LARAVEL_SUBPATH"
            PUBLIC_HTML_DIR="${{ secrets.HOSTIDO_PUBLIC_HTML }}"

            echo "Project root: $PROJECT_ROOT"
            echo "Laravel dir: $LARAVEL_DIR"

            cd "$PROJECT_ROOT"

            # Make sure remote is on SSH (git@github.com:...)
            # git remote set-url origin git@github.com:yourusername/yourrepository.git
            git fetch --all
            git reset --hard origin/main

            # Instalation of composer in the internal laravel directory
            cd "$LARAVEL_DIR"
            composer install --no-interaction --no-dev --optimize-autoloader

            # If node is installed, build frontend
            if command -v npm >/dev/null 2>&1; then
              npm ci
              npm run build
            else
              echo "npm not found on server — skipping frontend build"
            fi

            # migrations and caches (run in laravel directory)
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan storage:link || true

            # Copy public to public_html (Hostido standard)
            # Assuming public_html is next to app (typical for Hostido: ~/domains/handmademalin.pl/public_html)
            if [ -d "$PUBLIC_HTML_DIR" ]; then
              echo "Copying public to $PUBLIC_HTML_DIR"
              cp -r "$LARAVEL_DIR/public/"* "$PUBLIC_HTML_DIR/"
            else
              echo "Not found $PUBLIC_HTML_DIR — check public_html path"
            fi

            # Permissions
            chmod -R 775 "$LARAVEL_DIR/storage" "$LARAVEL_DIR/bootstrap/cache" || true
            chown -R www-data:www-data "$LARAVEL_DIR/storage" "$LARAVEL_DIR/bootstrap/cache" || true

            echo "Deployed successfully!"
